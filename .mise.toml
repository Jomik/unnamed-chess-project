[tools]
rust = { version = "latest", components = "rust-src, llvm-tools, rust-analyzer" }
"cargo:espup" = "latest"
"cargo:cargo-espflash" = "latest"
"cargo:ldproxy" = "latest"

[env]
'_'.source = "~/export-esp.sh"
# Auto-detect host target
HOST_TARGET = "{{ exec(command='rustc -vV | grep host | cut -d\" \" -f2') }}"

[hooks]
enter = '''
if ! [ -f ~/export-esp.sh ]; then
    echo "⚠️  ESP toolchain not detected. Run: mise run setup-esp"
fi
'''

[tasks.setup-esp]
description = "Install ESP targets (run once after mise install)"
run = "espup install"


[tasks.dev]
description = "Run development"
run = "cargo run --target $HOST_TARGET"

[tasks.test]
description = "Run tests on host"
run = "cargo test --target $HOST_TARGET"

[tasks.flash]
description = "Flash to ESP32 (uses esp toolchain)"
run = "cargo +esp espflash flash --release --target xtensa-esp32-espidf"

[tasks.build]
description = "Build for ESP32 (uses esp toolchain)"
run = "cargo +esp build --release --target xtensa-esp32-espidf"

[tasks.monitor]
description = "Monitor ESP32 serial output"
run = "espflash monitor"
